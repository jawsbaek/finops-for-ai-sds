<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>ì‹¤ì‹œê°„ ë¹„ìš© ì„ê³„ê°’ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼</title>
    <status>drafted</status>
    <generatedAt>2025-11-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-4-ì‹¤ì‹œê°„-ë¹„ìš©-ì„ê³„ê°’-ëª¨ë‹ˆí„°ë§-ë°-ì•Œë¦¼.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>FinOps ê´€ë¦¬ì</asA>
    <iWant>í”„ë¡œì íŠ¸ë³„ ì¼ì¼/ì£¼ê°„ ë¹„ìš© ì„ê³„ê°’ì„ ì„¤ì •í•˜ê³  ì´ˆê³¼ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ì„ ë°›ì•„</iWant>
    <soThat>ë¹„ìš© í­ì£¼ë¥¼ ì¡°ê¸°ì— ë°œê²¬í•˜ê³  ì‹ ì†íˆ ëŒ€ì‘í•  ìˆ˜ ìˆë‹¤</soThat>
    <tasks>
- Task 1: ë¹„ìš© ì„ê³„ê°’ ì•Œë¦¼ tRPC router ìƒì„± (AC: #1)
  - src/server/api/routers/alert.ts ìƒì„±
  - setThreshold í”„ë¡œì‹œì € êµ¬í˜„ (ì¼ì¼/ì£¼ê°„ ì„ê³„ê°’ ì„¤ì •)
  - getAlerts í”„ë¡œì‹œì € êµ¬í˜„ (í”„ë¡œì íŠ¸ì˜ í™œì„± ì„ê³„ê°’ ì¡°íšŒ)
  - updateAlert í”„ë¡œì‹œì € êµ¬í˜„ (ì„ê³„ê°’ ìˆ˜ì •)
  - deleteAlert í”„ë¡œì‹œì € êµ¬í˜„ (ì„ê³„ê°’ ì‚­ì œ/ë¹„í™œì„±í™”)
  - src/server/api/root.tsì— alertRouter ì¶”ê°€

- Task 2: Threshold Monitor ì„œë¹„ìŠ¤ êµ¬í˜„ (AC: #2)
  - src/lib/services/monitoring/threshold-monitor.ts ìƒì„±
  - checkThresholds í•¨ìˆ˜ êµ¬í˜„ (ëª¨ë“  í™œì„± í”„ë¡œì íŠ¸ ì„ê³„ê°’ ê²€ì‚¬)
  - calculateCurrentCost í•¨ìˆ˜ êµ¬í˜„ (ì¼ì¼/ì£¼ê°„ ë¹„ìš© ì§‘ê³„)
  - Alert throttling ë¡œì§ êµ¬í˜„ (1ì‹œê°„ë‹¹ ìµœëŒ€ 1íšŒ)
  - ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ìµœì í™” (cost_data ì¡°íšŒ ì„±ëŠ¥)

- Task 3: Slack ì•Œë¦¼ ì„œë¹„ìŠ¤ êµ¬í˜„ (AC: #3, #4, #5)
  - src/lib/services/slack/webhook.ts ìƒì„±
  - sendCostAlert í•¨ìˆ˜ êµ¬í˜„ (Slack webhook POST)
  - Slack ë©”ì‹œì§€ í¬ë§· êµ¬í˜„ (Blocks API)
  - "ìƒì„¸ ë³´ê¸°" ë²„íŠ¼ê³¼ deep link í¬í•¨
  - ì—ëŸ¬ í•¸ë“¤ë§ ë° ì¬ì‹œë„ ë¡œì§ (3íšŒ, exponential backoff)

- Task 4: Email ì•Œë¦¼ ì„œë¹„ìŠ¤ êµ¬í˜„ (AC: #3, #4, #5)
  - src/lib/services/email/resend-client.ts ìƒì„±
  - src/lib/services/email/templates/CostAlertEmail.tsx ìƒì„± (React Email)
  - sendCostAlertEmail í•¨ìˆ˜ êµ¬í˜„ (Resend API)
  - ì´ë©”ì¼ í…œí”Œë¦¿: í”„ë¡œì íŠ¸ëª…, í˜„ì¬ ë¹„ìš©, ì„ê³„ê°’, ì´ˆê³¼ìœ¨, ìƒì„¸ ë³´ê¸° ë§í¬
  - ì—ëŸ¬ í•¸ë“¤ë§ (Resend API ì‹¤íŒ¨ ì‹œ Sentry ë¡œê·¸)

- Task 5: Vercel Cron Job ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (AC: #2)
  - src/app/api/cron/poll-threshold/route.ts ìƒì„±
  - CRON_SECRET ê²€ì¦ ë¯¸ë“¤ì›¨ì–´
  - Threshold Monitor í˜¸ì¶œ (5ë¶„ë§ˆë‹¤ ì‹¤í–‰)
  - Alert ë°œì†¡ (Slack + Email ë³‘ë ¬ í˜¸ì¶œ)
  - Alert throttling ìƒíƒœ ê´€ë¦¬ (last_alert_sent_at ê¸°ë¡)
  - ì‹¤í–‰ ë¡œê·¸ ë° ì—ëŸ¬ ì¶”ì  (Pino + Sentry)

- Task 6: í”„ë¡œì íŠ¸ ì„¤ì • í˜ì´ì§€ UI êµ¬í˜„ (AC: #1)
  - src/app/(dashboard)/projects/[id]/settings/page.tsx ìƒì„±
  - ì„ê³„ê°’ ì„¤ì • í¼ ì»´í¬ë„ŒíŠ¸ (ì¼ì¼/ì£¼ê°„ ì„ íƒ, ê¸ˆì•¡ ì…ë ¥)
  - tRPC api.alert.setThreshold.useMutation() í˜¸ì¶œ
  - í˜„ì¬ ì„¤ì •ëœ ì„ê³„ê°’ í‘œì‹œ
  - Toast ì•Œë¦¼ (ì„¤ì • ì„±ê³µ/ì‹¤íŒ¨)

- Task 7: vercel.json Cron ìŠ¤ì¼€ì¤„ ì¶”ê°€ (AC: #2)
  - vercel.jsonì— poll-threshold cron ì¶”ê°€
  - Schedule: "*/5 * * * *" (5ë¶„ë§ˆë‹¤)
  - CRON_SECRET í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (openssl rand -base64 32)

- Task 8: í†µí•© í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
  - Threshold Monitor ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Vitest)
  - Alert ë°œì†¡ í†µí•© í…ŒìŠ¤íŠ¸ (MSWë¡œ Slack/Resend API ëª¨í‚¹)
  - E2E í…ŒìŠ¤íŠ¸: ì„ê³„ê°’ ì„¤ì • â†’ Cron íŠ¸ë¦¬ê±° â†’ ì•Œë¦¼ í™•ì¸
  - NFR002 ê²€ì¦: ì•Œë¦¼ ì§€ì—° <5ë¶„ ì¸¡ì •
  - TypeScript type checking passed
  - Production build successful
    </tasks>
  </story>

  <acceptanceCriteria>
1. í”„ë¡œì íŠ¸ ì„¤ì • í˜ì´ì§€ì—ì„œ ì¼ì¼/ì£¼ê°„ ë¹„ìš© ì„ê³„ê°’ì„ ì„¤ì •í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤ (FR004)
2. ì‹œìŠ¤í…œì€ OpenAI API ë¹„ìš© ë°ì´í„°ë¥¼ 5ë¶„ë§ˆë‹¤ í™•ì¸í•˜ì—¬ ì„ê³„ê°’ ì´ˆê³¼ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•´ì•¼ í•œë‹¤
3. ì„ê³„ê°’ ì´ˆê³¼ ì‹œ 1ë¶„ ì´ë‚´ì— Slack ë° ì´ë©”ì¼ ì•Œë¦¼ì„ ë°œì†¡í•´ì•¼ í•œë‹¤ (NFR002, FR004)
4. ì•Œë¦¼ ë©”ì‹œì§€ëŠ” "í”„ë¡œì íŠ¸ëª…, í˜„ì¬ ë¹„ìš©, ì„ê³„ê°’, ì´ˆê³¼ìœ¨"ì„ í¬í•¨í•´ì•¼ í•œë‹¤
5. ì•Œë¦¼ ë©”ì‹œì§€ì— "ìƒì„¸ ë³´ê¸°" ë§í¬ê°€ í¬í•¨ë˜ì–´ ëŒ€ì‹œë³´ë“œë¡œ ì¦‰ì‹œ ì´ë™í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Phase 1A - Real-time Cost Runaway Prevention</section>
        <snippet>FR004: ì‹œìŠ¤í…œì€ í”„ë¡œì íŠ¸ë³„ ì¼ì¼/ì£¼ê°„ ë¹„ìš© ì„ê³„ê°’ì„ ì„¤ì •í•˜ê³ , ì´ˆê³¼ ì‹œ ì¦‰ì‹œ(&lt;1ë¶„) Slack/ì´ë©”ì¼ ì•Œë¦¼ì„ ë°œì†¡í•´ì•¼ í•œë‹¤. NFR002: ì‹œìŠ¤í…œì€ ë¹„ìš© ì„ê³„ê°’ ì´ˆê³¼ ê°ì§€ í›„ 5ë¶„ ì´ë‚´ì— ì•Œë¦¼ì„ ë°œì†¡í•´ì•¼ í•œë‹¤ (5ë¶„ í´ë§ ì£¼ê¸°).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Communication Patterns - Slack Notifications</section>
        <snippet>Slack ì•Œë¦¼ í¬ë§·: Blocks API ì‚¬ìš©. text: "ğŸš¨ [íŒ€ëª…] ë¹„ìš© ì„ê³„ê°’ ì´ˆê³¼", ìƒì„¸ ë³´ê¸° ë²„íŠ¼ í¬í•¨. React Email í…œí”Œë¦¿ìœ¼ë¡œ ì´ë©”ì¼ ë°œì†¡ (Resend API).</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification</title>
        <section>Workflow 2: ì‹¤ì‹œê°„ ë¹„ìš© í­ì£¼ ë°©ì§€</section>
        <snippet>5ë¶„ë§ˆë‹¤ (Vercel Cron) â†’ GET /api/cron/poll-threshold â†’ CRON_SECRET ê²€ì¦ â†’ ëª¨ë“  í™œì„± í”„ë¡œì íŠ¸ ì„ê³„ê°’ ì¡°íšŒ (cost_alerts) â†’ í˜„ì¬ ì¼ì¼/ì£¼ê°„ ë¹„ìš© ì§‘ê³„ â†’ IF ë¹„ìš© &gt; ì„ê³„ê°’: Slack webhook + Resend API í˜¸ì¶œ + Throttling (1ì‹œê°„ë‹¹ ìµœëŒ€ 1íšŒ).</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification</title>
        <section>APIs and Interfaces - alertRouter</section>
        <snippet>alertRouter: setThreshold í”„ë¡œì‹œì € êµ¬í˜„. Input: projectId (string), type (enum: "daily" | "weekly"), value (number, positive). Mutationìœ¼ë¡œ ì„ê³„ê°’ ì„¤ì •.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Implementation Patterns - Cron Job Security</section>
        <snippet>Cron Job ë³´ì•ˆ: CRON_SECRET Bearer token ê²€ì¦, Idempotency ì²´í¬, ì‹¤í–‰ ë¡œê·¸ ë° ì—ëŸ¬ ì¶”ì  (Pino + Sentry).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>database schema</kind>
        <symbol>CostAlert (model exists, needs last_alert_sent_at column)</symbol>
        <lines>N/A - new model needed</lines>
        <reason>Story 1.4 needs CostAlert model with threshold_type, threshold_value, is_active. May need last_alert_sent_at for throttling.</reason>
      </artifact>
      <artifact>
        <path>src/server/api/routers/cost.ts</path>
        <kind>tRPC router</kind>
        <symbol>costRouter (existing)</symbol>
        <lines>1-280</lines>
        <reason>Existing pattern for protectedProcedure, team access verification, date-based cost queries. New alertRouter will follow same pattern.</reason>
      </artifact>
      <artifact>
        <path>src/app/api/cron/daily-batch/route.ts</path>
        <kind>cron endpoint</kind>
        <symbol>GET handler (existing)</symbol>
        <lines>38-169</lines>
        <reason>Existing Cron Job pattern: CRON_SECRET verification (constantTimeCompare), Idempotency check (cron_logs), error handling, Pino logging. Reuse for poll-threshold endpoint.</reason>
      </artifact>
      <artifact>
        <path>src/lib/services/openai/cost-collector.ts</path>
        <kind>service</kind>
        <symbol>retryWithBackoff (function)</symbol>
        <lines>51-76</lines>
        <reason>Retry logic with exponential backoff (1s, 2s, 4s) for Slack/Resend API calls. Reuse pattern for alert notification services.</reason>
      </artifact>
      <artifact>
        <path>src/lib/services/email/notification.ts</path>
        <kind>service</kind>
        <symbol>sendCostCollectionFailureNotification</symbol>
        <lines>N/A (file exists)</lines>
        <reason>Existing email notification service using Resend. Pattern to follow for cost alert email notifications.</reason>
      </artifact>
      <artifact>
        <path>src/lib/services/encryption/kms-envelope.ts</path>
        <kind>service</kind>
        <symbol>KMSEnvelopeEncryption (class)</symbol>
        <lines>N/A (file exists)</lines>
        <reason>Not needed for Story 1.4 (no encryption), but available if API keys accessed during threshold monitoring.</reason>
      </artifact>
      <artifact>
        <path>src/server/api/root.ts</path>
        <kind>tRPC root router</kind>
        <symbol>appRouter</symbol>
        <lines>N/A</lines>
        <reason>Need to add alertRouter to the root router exports.</reason>
      </artifact>
      <artifact>
        <path>vercel.json</path>
        <kind>configuration</kind>
        <symbol>crons array</symbol>
        <lines>2-7</lines>
        <reason>Existing daily-batch cron. Need to add poll-threshold cron with schedule "*/5 * * * *" (every 5 minutes).</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>next</package>
        <version>^15.2.3</version>
        <usage>App Router, API Routes</usage>
      </node>
      <package>@trpc/server</package>
      <version>^11.0.0</version>
      <usage>tRPC alertRouter implementation</usage>
      </package>
      <package>prisma</package>
      <version>^6.5.0</version>
      <usage>Database ORM for CostAlert model</usage>
      </package>
      <package>resend</package>
      <version>^6.4.0</version>
      <usage>Email alert notifications</usage>
      </package>
      <package>react-email</package>
      <version>^4.3.2</version>
      <usage>React Email templates for cost alerts</usage>
      </package>
      <package>pino</package>
      <version>^10.1.0</version>
      <usage>Structured logging for Cron jobs</usage>
      </package>
      <package>date-fns</package>
      <version>^4.1.0</version>
      <usage>Date manipulation for daily/weekly cost aggregation</usage>
      </package>
      <package>zod</package>
      <version>^3.24.2</version>
      <usage>Input validation for alertRouter schemas</usage>
      </package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>CRITICAL: CostAlert model may need last_alert_sent_at column for throttling (1ì‹œê°„ë‹¹ ìµœëŒ€ 1íšŒ). Consider adding AlertLog table for audit trail (Story 1.5 AC5 prep).</constraint>
    <constraint>Design System: Use Premium Indigo theme from src/styles/globals.css. Use semantic colors: --color-warning, --color-success, text-warning for alert UI. Avoid Tailwind raw colors (gray-900, blue-50).</constraint>
    <constraint>tRPC Pattern: Follow existing costRouter pattern - protectedProcedure, team access verification via TeamMember table, TRPCError with descriptive Korean messages.</constraint>
    <constraint>Cron Job Security: MUST verify CRON_SECRET using constantTimeCompare (timing-safe comparison). Store CRON_SECRET in Vercel environment variables.</constraint>
    <constraint>Idempotency: NOT required for poll-threshold (different from daily-batch). Threshold monitoring is real-time, runs every 5 minutes by design.</constraint>
    <constraint>Alert Throttling: Track last_alert_sent_at per project. Only send alert if &gt;1 hour since last alert for same project.</constraint>
    <constraint>Parallel Notification: Use Promise.all([sendSlack(), sendEmail()]) to minimize latency and meet NFR002 (&lt;5ë¶„).</constraint>
    <constraint>NFR002 Compliance: Total Cron execution time (threshold check + alert send) must complete &lt;5 minutes. Optimize database queries with indexes on cost_data(team_id, date) and cost_data(project_id, date).</constraint>
    <constraint>Error Handling: Slack/Resend API failures should be logged to Sentry but NOT block Cron job completion. Retry 3 times with exponential backoff (1s, 2s, 4s) using retryWithBackoff pattern.</constraint>
    <constraint>Slack Webhook: Use environment variable SLACK_WEBHOOK_URL. Blocks API format with type: "section" and type: "actions" for "ìƒì„¸ ë³´ê¸°" button.</constraint>
    <constraint>React Email: Create template at src/lib/services/email/templates/CostAlertEmail.tsx. Use @react-email/components. Props: projectName, currentCost, threshold, exceedancePercent, dashboardUrl.</constraint>
    <constraint>File Structure: src/lib/services/slack/webhook.ts (NEW), src/lib/services/monitoring/threshold-monitor.ts (NEW), src/app/api/cron/poll-threshold/route.ts (NEW).</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>alertRouter.setThreshold</name>
      <kind>tRPC Mutation</kind>
      <signature>
setThreshold: protectedProcedure
  .input(z.object({
    projectId: z.string(),
    type: z.enum(["daily", "weekly"]),
    value: z.number().positive()
  }))
  .mutation(async ({ input, ctx }) =&gt; {
    // Create or update CostAlert
  })
      </signature>
      <path>src/server/api/routers/alert.ts</path>
    </interface>
    <interface>
      <name>alertRouter.getAlerts</name>
      <kind>tRPC Query</kind>
      <signature>
getAlerts: protectedProcedure
  .input(z.object({ projectId: z.string() }))
  .query(async ({ input, ctx }) =&gt; {
    // Get active alerts for project
  })
      </signature>
      <path>src/server/api/routers/alert.ts</path>
    </interface>
    <interface>
      <name>checkThresholds</name>
      <kind>Service Function</kind>
      <signature>
async function checkThresholds(): Promise&lt;AlertEvent[]&gt; {
  // Query all active CostAlert records
  // For each alert: aggregate daily/weekly cost from cost_data
  // Compare with threshold_value
  // Return array of exceeded alerts
}
      </signature>
      <path>src/lib/services/monitoring/threshold-monitor.ts</path>
    </interface>
    <interface>
      <name>sendCostAlert</name>
      <kind>Service Function</kind>
      <signature>
async function sendCostAlert(params: {
  projectName: string;
  currentCost: number;
  threshold: number;
  exceedancePercent: number;
  dashboardUrl: string;
}): Promise&lt;void&gt; {
  // Send Slack webhook POST
  // Retry 3 times with exponential backoff
}
      </signature>
      <path>src/lib/services/slack/webhook.ts</path>
    </interface>
    <interface>
      <name>sendCostAlertEmail</name>
      <kind>Service Function</kind>
      <signature>
async function sendCostAlertEmail(params: {
  to: string;
  projectName: string;
  currentCost: number;
  threshold: number;
  exceedancePercent: number;
  dashboardUrl: string;
}): Promise&lt;void&gt; {
  // Render React Email template
  // Send via Resend API
  // Retry 3 times with exponential backoff
}
      </signature>
      <path>src/lib/services/email/resend-client.ts</path>
    </interface>
    <interface>
      <name>CostAlert Prisma Model</name>
      <kind>Database Model</kind>
      <signature>
model CostAlert {
  id              String   @id @default(cuid())
  project_id      String
  threshold_type  String   // "daily" | "weekly"
  threshold_value Decimal  @db.Decimal(10,2)
  is_active       Boolean  @default(true)
  last_alert_sent_at DateTime? // For throttling
  created_at      DateTime @default(now())

  @@map("cost_alerts")
}
      </signature>
      <path>prisma/schema.prisma</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Vitest for unit tests (src/lib/services/**/__tests__/*.test.ts). MSW (Mock Service Worker) for mocking Slack/Resend APIs in integration tests. Playwright for E2E tests (__tests__/e2e/). Coverage target: 80% lines/functions/branches/statements.
    </standards>
    <locations>
- Unit tests: src/lib/services/monitoring/__tests__/threshold-monitor.test.ts
- Unit tests: src/lib/services/slack/__tests__/webhook.test.ts
- Unit tests: src/lib/services/email/__tests__/resend-client.test.ts
- Integration tests: src/server/api/routers/__tests__/alert.test.ts
- E2E tests: __tests__/e2e/cost-threshold-alert.spec.ts
    </locations>
    <ideas>
      <idea ac="1">
Test setThreshold tRPC mutation: Create CostAlert record, verify threshold_type and threshold_value persisted correctly.
      </idea>
      <idea ac="2">
Test checkThresholds function: Mock cost_data with costs exceeding daily/weekly thresholds, verify correct AlertEvent[] returned.
      </idea>
      <idea ac="3">
Test sendCostAlert (Slack): Mock Slack webhook API with MSW, verify POST payload format (Blocks API), retry logic on 5xx errors. Measure alert send time (&lt;5ì´ˆ).
      </idea>
      <idea ac="3">
Test sendCostAlertEmail (Resend): Mock Resend API with MSW, verify email template rendering, retry logic, error handling (Sentry log).
      </idea>
      <idea ac="3">
Test NFR002 (alert latency &lt;5ë¶„): E2E test - set threshold, trigger cost data update, verify Cron runs within 5 minutes, alert received.
      </idea>
      <idea ac="4">
Test alert message content: Verify Slack/Email messages include projectName, currentCost, threshold, exceedancePercent (all fields).
      </idea>
      <idea ac="5">
Test deep link: Verify Slack "ìƒì„¸ ë³´ê¸°" button URL links to correct dashboard project detail page.
      </idea>
      <idea ac="all">
Test alert throttling: Send multiple threshold breaches within 1 hour, verify only 1 alert sent. After 1 hour, verify new alert sent.
      </idea>
      <idea ac="2">
Test Cron Job security: Attempt to call /api/cron/poll-threshold without CRON_SECRET, verify 401 Unauthorized response.
      </idea>
      <idea ac="2">
Test database query performance: EXPLAIN ANALYZE on cost aggregation queries, verify indexes used, query time &lt;1ì´ˆ for 100 projects.
      </idea>
    </ideas>
  </tests>
</story-context>
