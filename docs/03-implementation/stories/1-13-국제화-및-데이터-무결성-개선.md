# Story 1.13: êµ­ì œí™” ë° ë°ì´í„° ë¬´ê²°ì„± ê°œì„ 

**Status:** ğŸ“‹ TODO

**Priority:** ğŸŸ¢ LOW

---

## User Story

**As a** í•œêµ­ì–´ ì‚¬ìš©ì,
**I want** ëª¨ë“  ì—ëŸ¬ ë©”ì‹œì§€ì™€ ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ í•œêµ­ì–´ë¡œ í‘œì‹œë˜ê³  ë°ì´í„° ë¬´ê²°ì„±ì´ ë³´ì¥ë˜ì–´,
**So that** ì¼ê´€ëœ ì‚¬ìš©ì ê²½í—˜ê³¼ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

---

## Context

**Code Review ë°œê²¬ ì‚¬í•­ (Story 1.10):**

### Issue #1: ì˜ì–´ ì—ëŸ¬ ë©”ì‹œì§€ (HIGH)
**ë¬¸ì œ:**
```typescript
// src/server/api/routers/team.ts
throw new TRPCError({
  code: "FORBIDDEN",
  message: "You do not have access to this team",  // âŒ English
});

throw new TRPCError({
  code: "NOT_FOUND",
  message: "Team not found",  // âŒ English
});
```

```typescript
// src/server/api/routers/project.ts
throw new TRPCError({
  code: "FORBIDDEN",
  message: "You do not have permission to access this project",  // âŒ English
});

throw new TRPCError({
  code: "BAD_REQUEST",
  message: "Reason is required",  // âŒ English
});
```

**ë¬¸ì œì :**
- UIëŠ” í•œêµ­ì–´ì¸ë° ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ì˜ì–´ë¡œ í‘œì‹œ
- ì¼ê´€ì„± ì—†ëŠ” ì‚¬ìš©ì ê²½í—˜
- í•œêµ­ì–´ ì‚¬ìš©ìì˜ ì´í•´ë„ ì €í•˜

**í•´ê²° ë°©ë²•:**
- ëª¨ë“  backend ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­
- ì—ëŸ¬ ë©”ì‹œì§€ constants íŒŒì¼ ìƒì„±í•˜ì—¬ ì¤‘ì•™ ê´€ë¦¬

### Issue #2: Audit Log Transaction Safety (MEDIUM)
**ë¬¸ì œ:**
```typescript
// src/server/api/routers/project.ts - deleteApiKey
await db.auditLog.create({
  data: {
    userId,
    actionType: "api_key_deleted",
    resourceId: input.apiKeyId,
    metadata: { reason: input.reason }
  }
});  // âš ï¸ If this succeeds but delete fails, orphaned audit log

await db.apiKey.delete({
  where: { id: input.apiKeyId }
});  // âš ï¸ If this fails, audit log is incorrect
```

**ë¬¸ì œì :**
- Audit log ìƒì„±ê³¼ ì‹¤ì œ ì‚­ì œê°€ ë³„ë„ íŠ¸ëœì­ì…˜
- ì‚­ì œ ì‹¤íŒ¨ ì‹œ audit logê°€ ì˜ëª»ëœ ìƒíƒœë¡œ ë‚¨ìŒ
- ë°ì´í„° ë¬´ê²°ì„± ìœ„ë°˜

**í•´ê²° ë°©ë²•:**
```typescript
await db.$transaction([
  db.auditLog.create({ ... }),
  db.apiKey.delete({ ... }),
]);
```

### Issue #3: Input Validation Length Limits (MEDIUM)
**ë¬¸ì œ:**
```typescript
// src/server/api/routers/project.ts
disableApiKey: protectedProcedure
  .input(z.object({
    apiKeyId: z.string(),
    reason: z.string().optional(),  // âš ï¸ No max length
  }))
```

**ë¬¸ì œì :**
- ì‚¬ìœ  í•„ë“œì— ê¸¸ì´ ì œí•œ ì—†ìŒ
- ì•…ì˜ì ìœ¼ë¡œ ê¸´ í…ìŠ¤íŠ¸ ì…ë ¥ ê°€ëŠ¥ (DoS)
- DB ì €ì¥ ê³µê°„ ë‚­ë¹„

**í•´ê²° ë°©ë²•:**
```typescript
reason: z.string().min(1, "ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤").max(500, "ì‚¬ìœ ëŠ” 500ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”")
```

### Issue #4: Inconsistent Error Handling (LOW)
**ë¬¸ì œ:**
- ì¼ë¶€ ì—ëŸ¬ëŠ” toastë¡œ í‘œì‹œ, ì¼ë¶€ëŠ” console.error
- ì—ëŸ¬ ë¡œê¹… í‘œì¤€ ë¶€ì¬

**í•´ê²° ë°©ë²•:**
- í†µì¼ëœ ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´ ì ìš©
- Sentry ë“± ì—ëŸ¬ ì¶”ì  ì‹œìŠ¤í…œ í†µí•© (ì„ íƒì‚¬í•­)

---

## Acceptance Criteria

### 1. í•œêµ­ì–´ ì—ëŸ¬ ë©”ì‹œì§€ ì ìš©
- [ ] `src/lib/error-messages.ts` íŒŒì¼ ìƒì„± (ì—ëŸ¬ ë©”ì‹œì§€ constants)
- [ ] ëª¨ë“  backend ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í•œêµ­ì–´ë¡œ ë³€í™˜:
  - `team.ts`: 5ê°œ ì—ëŸ¬ ë©”ì‹œì§€
  - `project.ts`: 12ê°œ ì—ëŸ¬ ë©”ì‹œì§€
  - ê¸°íƒ€ routers
- [ ] Zod validation ì—ëŸ¬ ë©”ì‹œì§€ë„ í•œêµ­ì–´ë¡œ ì„¤ì •
- [ ] í”„ë¡ íŠ¸ì—”ë“œ toast ë©”ì‹œì§€ ì¼ê´€ì„± í™•ì¸
- [ ] ëª¨ë“  ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸í•˜ì—¬ í•œêµ­ì–´ í‘œì‹œ í™•ì¸

### 2. ë°ì´í„° ë¬´ê²°ì„± ê°•í™” (Transactions)
- [ ] `deleteApiKey` mutationì— transaction ì ìš©
- [ ] `disableApiKey` mutationì— transaction ì ìš©
- [ ] `enableApiKey` mutationì— transaction ì ìš©
- [ ] Critical operationsì— transaction íŒ¨í„´ ì ìš©:
  - Audit log + actual operation = atomic
  - Rollback on error
- [ ] Transaction ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ (í•œêµ­ì–´)

### 3. Input Validation ê°•í™”
- [ ] ëª¨ë“  string ì…ë ¥ì— max length ì„¤ì •:
  - `reason`: 500ì
  - `projectName`: 100ì
  - `email`: 320ì (RFC 5321)
  - `name`: 100ì
- [ ] Zod schema ì—…ë°ì´íŠ¸
- [ ] í”„ë¡ íŠ¸ì—”ë“œì—ë„ ë™ì¼í•œ validation ì ìš© (ì¦‰ê°ì  í”¼ë“œë°±)
- [ ] Validation ì‹¤íŒ¨ ì‹œ í•œêµ­ì–´ ë©”ì‹œì§€ í‘œì‹œ

### 4. ì—ëŸ¬ ë¡œê¹… í‘œì¤€í™”
- [ ] ëª¨ë“  mutationì— try-catch ì¶”ê°€
- [ ] ì—ëŸ¬ ë°œìƒ ì‹œ console.errorë¡œ ë¡œê¹… (dev)
- [ ] Production í™˜ê²½ì—ì„œëŠ” Sentry ë“±ìœ¼ë¡œ ì „ì†¡ (ì„ íƒì‚¬í•­)
- [ ] ì—ëŸ¬ ë¡œê·¸ì— context ì •ë³´ í¬í•¨ (userId, action, timestamp)

---

## Prerequisites

- Story 1.10 (í”„ë¡œì íŠ¸ ë©¤ë²„ ë° API í‚¤ ê´€ë¦¬ UI)

---

## Technical Implementation

### 1. í•œêµ­ì–´ ì—ëŸ¬ ë©”ì‹œì§€ Constants

```typescript
// src/lib/error-messages.ts
export const ERROR_MESSAGES = {
  // Team errors
  TEAM_NOT_FOUND: "íŒ€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
  TEAM_ACCESS_DENIED: "ì´ íŒ€ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.",
  TEAM_ADMIN_REQUIRED: "íŒ€ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.",
  TEAM_MEMBER_NOT_FOUND: "íŒ€ ë©¤ë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
  TEAM_MEMBER_ALREADY_EXISTS: "ì´ë¯¸ íŒ€ì— ì¶”ê°€ëœ ë©¤ë²„ì…ë‹ˆë‹¤.",

  // Project errors
  PROJECT_NOT_FOUND: "í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
  PROJECT_ACCESS_DENIED: "ì´ í”„ë¡œì íŠ¸ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.",
  PROJECT_MEMBER_NOT_FOUND: "í”„ë¡œì íŠ¸ ë©¤ë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
  PROJECT_MEMBER_ALREADY_EXISTS: "ì´ë¯¸ í”„ë¡œì íŠ¸ì— ì¶”ê°€ëœ ë©¤ë²„ì…ë‹ˆë‹¤.",
  PROJECT_MEMBER_CANNOT_REMOVE_SELF: "ë³¸ì¸ì„ í”„ë¡œì íŠ¸ì—ì„œ ì œê±°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",

  // API Key errors
  API_KEY_NOT_FOUND: "API í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
  API_KEY_ALREADY_DISABLED: "ì´ë¯¸ ë¹„í™œì„±í™”ëœ API í‚¤ì…ë‹ˆë‹¤.",
  API_KEY_ALREADY_ACTIVE: "ì´ë¯¸ í™œì„±í™”ëœ API í‚¤ì…ë‹ˆë‹¤.",
  API_KEY_INVALID_FORMAT: "ì˜¬ë°”ë¥´ì§€ ì•Šì€ API í‚¤ í˜•ì‹ì…ë‹ˆë‹¤.",
  API_KEY_DELETION_REASON_REQUIRED: "ì‚­ì œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.",
  API_KEY_DISABLE_REASON_REQUIRED: "ë¹„í™œì„±í™” ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.",

  // Validation errors
  VALIDATION_REASON_TOO_LONG: "ì‚¬ìœ ëŠ” 500ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.",
  VALIDATION_NAME_TOO_LONG: "ì´ë¦„ì€ 100ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.",
  VALIDATION_EMAIL_INVALID: "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.",
  VALIDATION_REQUIRED_FIELD: "í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.",

  // Generic errors
  INTERNAL_SERVER_ERROR: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
  UNAUTHORIZED: "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.",
  FORBIDDEN: "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.",
} as const;
```

**Usage:**
```typescript
// src/server/api/routers/team.ts
import { ERROR_MESSAGES } from "@/lib/error-messages";

getMembers: protectedProcedure
  .input(z.object({ teamId: z.string() }))
  .query(async ({ ctx, input }) => {
    const members = await db.teamMember.findMany({ ... });

    const currentUserMembership = members.find(m => m.userId === userId);
    if (!currentUserMembership) {
      throw new TRPCError({
        code: "FORBIDDEN",
        message: ERROR_MESSAGES.TEAM_ACCESS_DENIED,  // âœ… Korean
      });
    }

    return members;
  }),
```

### 2. Zod Validation í•œêµ­ì–´ ë©”ì‹œì§€

```typescript
// src/server/api/routers/project.ts
import { ERROR_MESSAGES } from "@/lib/error-messages";

disableApiKey: sensitiveProcedure
  .input(
    z.object({
      apiKeyId: z.string(),
      reason: z
        .string()
        .min(1, ERROR_MESSAGES.API_KEY_DISABLE_REASON_REQUIRED)
        .max(500, ERROR_MESSAGES.VALIDATION_REASON_TOO_LONG),
    })
  )
  .mutation(async ({ ctx, input }) => {
    // ... implementation
  }),

deleteApiKey: sensitiveProcedure
  .input(
    z.object({
      apiKeyId: z.string(),
      reason: z
        .string()
        .min(1, ERROR_MESSAGES.API_KEY_DELETION_REASON_REQUIRED)
        .max(500, ERROR_MESSAGES.VALIDATION_REASON_TOO_LONG),
    })
  )
  .mutation(async ({ ctx, input }) => {
    // ... implementation with transaction
  }),
```

### 3. Transaction Safety Implementation

**Before:**
```typescript
// src/server/api/routers/project.ts
deleteApiKey: sensitiveProcedure
  .input(z.object({ apiKeyId: z.string(), reason: z.string() }))
  .mutation(async ({ ctx, input }) => {
    // âš ï¸ Not atomic
    await db.auditLog.create({ ... });
    await db.apiKey.delete({ ... });
  }),
```

**After:**
```typescript
// src/server/api/routers/project.ts
import { ERROR_MESSAGES } from "@/lib/error-messages";

deleteApiKey: sensitiveProcedure
  .input(
    z.object({
      apiKeyId: z.string(),
      reason: z
        .string()
        .min(1, ERROR_MESSAGES.API_KEY_DELETION_REASON_REQUIRED)
        .max(500, ERROR_MESSAGES.VALIDATION_REASON_TOO_LONG),
    })
  )
  .mutation(async ({ ctx, input }) => {
    const userId = ctx.session.user.id;

    try {
      // Fetch API key first (for validation and audit metadata)
      const apiKey = await db.apiKey.findUnique({
        where: { id: input.apiKeyId },
        include: { project: { select: { id: true, teamId: true } } },
      });

      if (!apiKey) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: ERROR_MESSAGES.API_KEY_NOT_FOUND,
        });
      }

      // Permission check
      await ensureProjectAccess(userId, apiKey.project.id);

      // âœ… Atomic transaction: Audit log + Delete
      await db.$transaction([
        db.auditLog.create({
          data: {
            userId,
            actionType: "api_key_deleted",
            resourceType: "api_key",
            resourceId: input.apiKeyId,
            metadata: {
              reason: input.reason,
              projectId: apiKey.project.id,
              provider: apiKey.provider,
              wasActive: apiKey.isActive,
            },
          },
        }),
        db.apiKey.delete({
          where: { id: input.apiKeyId },
        }),
      ]);

      return { success: true };
    } catch (error) {
      // Improved error logging
      console.error("[deleteApiKey] Error:", {
        userId,
        apiKeyId: input.apiKeyId,
        error: error instanceof Error ? error.message : "Unknown error",
      });

      throw error;
    }
  }),
```

**Apply same pattern to:**
- `disableApiKey`
- `enableApiKey`
- Any other critical operations

### 4. Frontend Validation (Immediate Feedback)

```typescript
// src/components/dialogs/ConfirmDeleteKeyDialog.tsx
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { z } from "zod";

const deleteKeySchema = z.object({
  confirmText: z.literal("ì‚­ì œ", {
    errorMap: () => ({ message: "'ì‚­ì œ'ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”" }),
  }),
  reason: z
    .string()
    .min(1, "ì‚­ì œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    .max(500, "ì‚¬ìœ ëŠ” 500ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”"),
});

type DeleteKeyForm = z.infer<typeof deleteKeySchema>;

export function ConfirmDeleteKeyDialog({ ... }) {
  const { register, handleSubmit, formState: { errors } } = useForm<DeleteKeyForm>({
    resolver: zodResolver(deleteKeySchema),
  });

  const onSubmit = (data: DeleteKeyForm) => {
    onConfirm(data.reason);
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <Textarea
        {...register("reason")}
        placeholder="ì˜ˆ: ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ"
      />
      {errors.reason && (
        <p className="text-destructive text-sm">{errors.reason.message}</p>
      )}
      {/* ... */}
    </form>
  );
}
```

### 5. Error Logging í‘œì¤€í™”

```typescript
// src/lib/logger.ts
type LogLevel = "info" | "warn" | "error";

interface LogContext {
  userId?: string;
  action?: string;
  resource?: string;
  [key: string]: unknown;
}

export function logError(message: string, context?: LogContext) {
  const timestamp = new Date().toISOString();
  const logEntry = {
    timestamp,
    level: "error" as LogLevel,
    message,
    ...context,
  };

  if (process.env.NODE_ENV === "development") {
    console.error("[ERROR]", logEntry);
  } else {
    // Production: Send to Sentry, Datadog, etc.
    // Sentry.captureException(new Error(message), { extra: context });
  }
}
```

**Usage in mutations:**
```typescript
// src/server/api/routers/project.ts
import { logError } from "@/lib/logger";

deleteApiKey: sensitiveProcedure
  .mutation(async ({ ctx, input }) => {
    try {
      // ... implementation
    } catch (error) {
      logError("API key deletion failed", {
        userId: ctx.session.user.id,
        action: "deleteApiKey",
        resource: input.apiKeyId,
        error: error instanceof Error ? error.message : "Unknown error",
      });

      throw error;
    }
  }),
```

---

## Complete File Changes

### Files to Update

1. **Create:** `src/lib/error-messages.ts` (new file)
2. **Create:** `src/lib/logger.ts` (new file)
3. **Update:** `src/server/api/routers/team.ts` (5 error messages)
4. **Update:** `src/server/api/routers/project.ts` (12 error messages + transactions)
5. **Update:** `src/components/dialogs/ConfirmDeleteKeyDialog.tsx` (validation)
6. **Update:** `src/components/dialogs/ConfirmDisableKeyDialog.tsx` (validation)
7. **Update:** `src/components/dialogs/AddApiKeyDialog.tsx` (validation)

---

## Testing Checklist

### Error Message Tests
- [ ] íŒ€ ì ‘ê·¼ ê±°ë¶€ ì‹œ "ì´ íŒ€ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤" í‘œì‹œ
- [ ] í”„ë¡œì íŠ¸ ì ‘ê·¼ ê±°ë¶€ ì‹œ "ì´ í”„ë¡œì íŠ¸ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤" í‘œì‹œ
- [ ] API í‚¤ ì‚­ì œ ì‚¬ìœ  ì—†ì´ ì œì¶œ ì‹œ "ì‚­ì œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤" í‘œì‹œ
- [ ] 500ì ì´ˆê³¼ ì…ë ¥ ì‹œ "ì‚¬ìœ ëŠ” 500ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”" í‘œì‹œ

### Transaction Tests
- [ ] API í‚¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ audit logë„ ë¡¤ë°±ë˜ëŠ”ì§€ í™•ì¸
- [ ] Transaction ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ í•œêµ­ì–´ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
- [ ] Database consistency: Delete ì‹¤íŒ¨ ì‹œ audit log ì—†ìŒ

### Validation Tests
- [ ] 501ì ì‚¬ìœ  ì…ë ¥ ì‹œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì°¨ë‹¨
- [ ] ë¹ˆ ì‚¬ìœ  ì…ë ¥ ì‹œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì°¨ë‹¨
- [ ] "ì‚­ì œ" ì™¸ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œ ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”

---

## Success Metrics

- [ ] 100% í•œêµ­ì–´ ì—ëŸ¬ ë©”ì‹œì§€ (0ê°œ ì˜ì–´ ë©”ì‹œì§€ ë‚¨ìŒ)
- [ ] ëª¨ë“  critical operationsì— transaction ì ìš©
- [ ] Input validation 100% ì ìš©
- [ ] ì—ëŸ¬ ë¡œê·¸ í‘œì¤€í™” 100% ì™„ë£Œ

---

## Related Stories

- **Story 1.10**: í”„ë¡œì íŠ¸ ë©¤ë²„ ë° API í‚¤ ê´€ë¦¬ UI (ê¸°ë°˜)
- **Story 1.11**: ë³´ì•ˆ ê°•í™” (input validationê³¼ ì—°ê³„)
- **Story 1.12**: ì„±ëŠ¥ ìµœì í™” (transaction ì„±ëŠ¥ ê³ ë ¤)
