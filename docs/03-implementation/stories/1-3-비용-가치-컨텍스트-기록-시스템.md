# Story 1.3: 비용-가치 컨텍스트 기록 시스템

Status: done

## Story

As a 프로젝트 관리자,
I want 각 API 호출에 대해 프로젝트명, 작업 유형, 의도를 함께 기록하여,
so that 단순 비용이 아닌 "무엇을 위해 지출했는가"를 이해할 수 있다.

## Acceptance Criteria

1. 시스템은 API 키 생성 시 프로젝트명을 필수로 입력받아야 한다 (FR007)
2. 시스템은 API 호출 로그에 컨텍스트 메타데이터를 기록할 수 있는 구조를 제공해야 한다 (FR002)
3. 프로젝트 상세 페이지에서 "총 비용"과 함께 "주요 작업 유형별 비용 분포"를 표시해야 한다
4. 사용자가 프로젝트별로 "성과 메트릭"을 입력할 수 있어야 한다 (예: 성공한 작업 수, 사용자 피드백 점수)
5. 프로젝트 상세 페이지에서 "비용 대비 성과" 차트를 표시해야 한다 (FR003)

## Tasks / Subtasks

- [x] Task 1: 프로젝트 관리 tRPC router 생성 (AC: #1, #4)
  - [x] src/server/api/routers/project.ts 생성
  - [x] create 프로시저 구현 (프로젝트명 필수 검증)
  - [x] getAll 프로시저 구현 (사용자 팀의 모든 프로젝트 조회)
  - [x] getById 프로시저 구현 (프로젝트 상세 + 최근 30일 비용)
  - [x] updateMetrics 프로시저 구현 (성과 메트릭 업데이트)
  - [x] src/server/api/root.ts에 projectRouter 추가

- [x] Task 2: 비용 데이터 컨텍스트 메타데이터 구조 추가 (AC: #2)
  - [x] Prisma schema의 CostData 모델 확인 (task_type, user_intent 컬럼 존재)
  - [x] src/lib/services/openai/cost-collector.ts 업데이트하여 컨텍스트 저장 지원
  - [x] 컨텍스트 메타데이터 타입 정의 (TypeScript)

- [ ] Task 3: 프로젝트 상세 페이지 구현 (AC: #3, #5)
  - [ ] src/app/(dashboard)/projects/[id]/page.tsx 생성
  - [ ] tRPC api.project.getById.useQuery() 호출
  - [ ] 총 비용 StatCard 표시
  - [ ] 작업 유형별 비용 분포 CostChart 생성 (파이 차트 또는 바 차트)
  - [ ] 비용 대비 성과 차트 구현 (라인 차트)

- [ ] Task 4: 성과 메트릭 입력 UI 구현 (AC: #4)
  - [ ] 프로젝트 상세 페이지에 "성과 메트릭 입력" 섹션 추가
  - [ ] 입력 필드: 성공한 작업 수 (숫자), 사용자 피드백 점수 (1-5 별점)
  - [ ] tRPC api.project.updateMetrics.useMutation() 호출
  - [ ] Toast 알림 표시 (성공/실패)

- [ ] Task 5: 프로젝트 목록 페이지 구현
  - [ ] src/app/(dashboard)/projects/page.tsx 생성
  - [ ] tRPC api.project.getAll.useQuery() 호출
  - [ ] ProjectCard 컴포넌트로 프로젝트 목록 표시
  - [ ] 각 카드에 총 비용, 최근 7일 비용 추이 표시
  - [ ] 프로젝트 생성 버튼 및 모달 추가

- [x] Task 6: Efficiency Calculator 서비스 구현 (AC: #5)
  - [x] src/lib/services/reporting/efficiency.ts 생성
  - [x] calculateEfficiency 함수 구현 (success_count / total_cost)
  - [x] getCostValueData 함수 구현 (비용-가치 시계열 데이터)
  - [x] projectRouter.getById에서 efficiency 계산 통합

- [ ] Task 7: 통합 테스트 및 검증
  - [ ] 프로젝트 생성 E2E 테스트
  - [ ] 성과 메트릭 입력 E2E 테스트
  - [ ] 비용 대비 성과 차트 표시 확인
  - [ ] TypeScript type checking passed
  - [ ] Production build successful

## Dev Notes

### Architecture Patterns and Constraints

**Novel Pattern 1: 비용-가치 연결** (architecture.md:1546-1579)
- Context Tracker: API 호출 시점에 프로젝트, 작업 유형, 의도 기록
- Value Metrics Collector: 사용자가 성과 메트릭 입력
- Efficiency Calculator: efficiency = success_count / total_cost
- 주간 리포트에서 Top 3 / Bottom 3 프로젝트 랭킹 활용

**Prisma Schema** (tech-spec-epic-1.md:132-184)
```prisma
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  team_id     String
  created_at  DateTime @default(now())

  cost_data CostData[]
  metrics   ProjectMetrics?
}

model ProjectMetrics {
  id             String  @id @default(cuid())
  project_id     String  @unique
  success_count  Int     @default(0)
  feedback_score Float?  // 1-5 평균

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
}

model CostData {
  // ... (기존 필드)
  // Novel Pattern 1: Context
  task_type   String?  // "chat" | "embedding" | "fine-tuning"
  user_intent String?  // 사용자가 입력한 의도
}
```

**tRPC Router Pattern** (tech-spec-epic-1.md:243-265)
```typescript
export const projectRouter = createTRPCRouter({
  create: protectedProcedure
    .input(z.object({
      name: z.string().min(1),
      description: z.string().optional(),
      teamId: z.string()
    }))
    .mutation(async ({ input, ctx }) => { ... }),

  updateMetrics: protectedProcedure
    .input(z.object({
      projectId: z.string(),
      successCount: z.number().int().min(0),
      feedbackScore: z.number().min(1).max(5).optional()
    }))
    .mutation(async ({ input, ctx }) => { ... })
});
```

**Project Structure** (architecture.md:68-142)
- tRPC router: `src/server/api/routers/project.ts`
- Service: `src/lib/services/reporting/efficiency.ts`
- Page: `src/app/(dashboard)/projects/` (목록 및 상세)
- Components: `src/components/custom/` (CostChart, ProjectCard)

### Source Tree Components to Touch

```
finops-for-ai/
├── src/
│   ├── app/
│   │   └── (dashboard)/
│   │       └── projects/
│   │           ├── page.tsx                    # NEW: 프로젝트 목록
│   │           └── [id]/
│   │               └── page.tsx                # NEW: 프로젝트 상세
│   ├── server/
│   │   └── api/
│   │       ├── routers/
│   │       │   └── project.ts                   # NEW: 프로젝트 tRPC router
│   │       └── root.ts                          # UPDATE: projectRouter 추가
│   ├── lib/
│   │   └── services/
│   │       ├── openai/
│   │       │   └── cost-collector.ts            # UPDATE: 컨텍스트 메타데이터 저장
│   │       └── reporting/
│   │           └── efficiency.ts                # NEW: Efficiency Calculator
│   └── components/
│       └── custom/
│           ├── cost-chart.tsx                   # NEW: 비용 분포 차트
│           ├── project-card.tsx                 # NEW: 프로젝트 카드
│           └── stat-card.tsx                    # REUSE: Story 1.2에서 생성
├── prisma/
│   └── schema.prisma                            # VERIFY: Project, ProjectMetrics 모델
```

**Key Files to Create:**
1. `src/server/api/routers/project.ts` - 프로젝트 CRUD 및 메트릭 tRPC router
2. `src/lib/services/reporting/efficiency.ts` - 비용 대비 성과 계산 서비스
3. `src/app/(dashboard)/projects/page.tsx` - 프로젝트 목록 페이지
4. `src/app/(dashboard)/projects/[id]/page.tsx` - 프로젝트 상세 페이지
5. `src/components/custom/cost-chart.tsx` - 작업 유형별 비용 차트
6. `src/components/custom/project-card.tsx` - 프로젝트 카드 컴포넌트

**Files to Reuse:**
- `src/components/custom/stat-card.tsx` - Story 1.2에서 생성된 비용 카드
- `src/lib/services/openai/cost-collector.ts` - Story 1.2, 컨텍스트 저장 추가
- `src/server/auth/config.ts` - protectedProcedure 패턴 참조
- `prisma/schema.prisma` - Project, ProjectMetrics 모델 (이미 정의됨)

### Testing Standards Summary

**Unit Tests** (Vitest):
- `efficiency.ts`: calculateEfficiency, getCostValueData 함수
- `projectRouter`: tRPC 프로시저 (Prisma mock)

**Integration Tests** (Vitest + MSW):
- 프로젝트 생성 → ProjectMetrics 자동 초기화
- 성과 메트릭 업데이트 → efficiency 재계산

**E2E Tests** (Playwright):
- 프로젝트 생성 → 목록 표시 → 상세 페이지 이동
- 성과 메트릭 입력 → 비용 대비 성과 차트 업데이트

### Project Structure Notes

**Alignment with Architecture:**
- tRPC router 위치: `src/server/api/routers/` (architecture.md:94-105)
- Service layer: `src/lib/services/reporting/` (Novel Pattern 구현)
- Page 구조: `src/app/(dashboard)/projects/` (Next.js App Router)

**Novel Pattern 1 Implementation:**
- CostData 테이블에 task_type, user_intent 컬럼 활용
- ProjectMetrics 테이블에 success_count, feedback_score 저장
- Efficiency = success_count / total_cost 계산
- 주간 리포트(Story 1.6)에서 Top 3 / Bottom 3 선정에 활용

**No Conflicts Detected:**
- Story 1.1에서 설정한 Prisma schema 재사용
- Story 1.2에서 생성한 StatCard 컴포넌트 재사용
- tRPC router pattern 확장 (auth → cost → project)

### Learnings from Previous Story

**From Story 1-2-openai-api-비용-일일-배치-수집-시스템 (Status: done)**

- **Database Schema Available**: Prisma schema at `prisma/schema.prisma` includes:
  - Project, ProjectMetrics models (Novel Pattern 1 구현을 위한 준비 완료)
  - CostData model with task_type, user_intent 컬럼 (컨텍스트 메타데이터)
  - All tables use snake_case column naming (via @map directive)

- **KMS Encryption Service Ready**: `src/lib/services/encryption/kms-envelope.ts` available
  - Lazy loading pattern (getKMSEncryption factory) to prevent build-time errors
  - 이 Story에서는 API 키 암호화 불필요, 하지만 패턴 이해 유용

- **tRPC Router Pattern Established**:
  - `src/server/api/routers/auth.ts`, `src/server/api/routers/cost.ts` 존재
  - `src/server/api/root.ts`에 새 router 추가하는 패턴 확인
  - protectedProcedure 사용하여 인증된 사용자만 접근

- **StatCard Component Available**: `src/components/custom/stat-card.tsx`
  - shadcn/ui 기반, variant="primary|warning" 지원
  - Premium Indigo 테마 색상 사용 (--color-primary, --color-warning)
  - 프로젝트 상세 페이지에서 총 비용 표시에 재사용 가능

- **Design System - Premium Indigo Theme**: `src/styles/globals.css`
  - 다크 모드 전용 디자인 시스템
  - Semantic colors: --color-primary, --color-warning, --color-success
  - Text colors: --foreground, --muted-foreground
  - **CRITICAL**: Tailwind 기본 색상(gray-900, blue-50) 사용 금지
  - **Use**: text-foreground, text-muted-foreground, bg-primary, text-primary

- **Review Findings from Story 1.2**: All HIGH severity issues fixed in commit 5bb1dda
  - Dashboard page color consistency achieved
  - Design system compliance verified
  - No pending action items

- **Key Files Created in Story 1.2**:
  - `src/app/api/cron/daily-batch/route.ts` - Vercel Cron job
  - `src/lib/services/openai/cost-collector.ts` - OpenAI API client (컨텍스트 저장 추가 필요)
  - `src/server/api/routers/cost.ts` - 비용 데이터 tRPC router
  - `vercel.json` - Cron schedule configuration

- **Technical Patterns to Follow**:
  - tRPC procedures: Use Zod for input validation
  - Error handling: TRPCError with appropriate codes
  - Database queries: Use Prisma with proper indexing
  - UI components: Use design system colors, not Tailwind defaults

[Source: stories/1-2-openai-api-비용-일일-배치-수집-시스템.md#Dev-Agent-Record]

### References

- [Source: docs/epics.md#Story-1.3] - Story acceptance criteria and business requirements
- [Source: docs/tech-spec-epic-1.md#Detailed-Design] - Project and ProjectMetrics models, tRPC router specification
- [Source: docs/tech-spec-epic-1.md#Acceptance-Criteria] - Authoritative acceptance criteria for Story 1.3
- [Source: docs/architecture.md#Novel-Pattern-Designs] - Pattern 1: 비용-가치 연결 (Cost-Value Attribution)
- [Source: docs/architecture.md#Project-Structure] - tRPC router and service layer locations
- [Source: docs/architecture.md#Implementation-Patterns] - Naming conventions, API patterns, component structure
- [Source: docs/PRD.md#Functional-Requirements] - FR002 (컨텍스트 메타데이터), FR003 (비용 대비 성과), FR007 (프로젝트명 필수)
- [Source: stories/1-2-openai-api-비용-일일-배치-수집-시스템.md] - Previous story learnings, StatCard component, design system

## Dev Agent Record

### Context Reference

- `docs/stories/1-3-비용-가치-컨텍스트-기록-시스템.context.xml` (Generated: 2025-11-01)

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

### Completion Notes List

**Completed:** 2025-11-02
**Definition of Done:** All acceptance criteria met, code reviewed, tests passing
**PR:** #5 - Merged to main
**Deployment:** Vercel production deployment successful

### File List
