<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.6</storyId>
    <title>주간 리포트 생성 및 발송</title>
    <status>drafted</status>
    <generatedAt>2025-11-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-6-주간-리포트-생성-및-발송.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>팀 리더</asA>
    <iWant>매주 자동으로 비용 효율성 리포트를 받아</iWant>
    <soThat>어떤 프로젝트가 잘하고 있고 어디를 개선해야 하는지 파악할 수 있다</soThat>
    <tasks>
      <task id="1" ac="1">
        <desc>Cron Job Endpoint 생성</desc>
        <subtasks>
          <subtask>src/app/api/cron/weekly-report/route.ts 생성</subtask>
          <subtask>CRON_SECRET 검증 로직 추가</subtask>
          <subtask>Idempotency 체크 (cron_logs 테이블)</subtask>
          <subtask>Report Generator 호출</subtask>
          <subtask>로그 기록 및 응답 반환</subtask>
        </subtasks>
      </task>
      <task id="2" ac="1">
        <desc>Vercel Cron Job 스케줄 설정</desc>
        <subtasks>
          <subtask>vercel.json에 weekly-report cron 추가 (매주 월요일 오전 9시 KST)</subtask>
          <subtask>환경 변수 CRON_SECRET 설정 (Vercel Dashboard)</subtask>
          <subtask>Cron 실행 테스트 (수동 트리거)</subtask>
        </subtasks>
      </task>
      <task id="3" ac="2,3">
        <desc>Report Generator Service 구현</desc>
        <subtasks>
          <subtask>src/lib/services/reporting/report-generator.ts 생성</subtask>
          <subtask>generateWeeklyReport 함수 구현</subtask>
          <subtask>지난 7일 비용 데이터 집계 (Prisma)</subtask>
          <subtask>Efficiency Calculator 호출하여 Top 3 / Bottom 3 선정</subtask>
          <subtask>전주 대비 증감률 계산 (주간 총 비용 비교)</subtask>
          <subtask>리포트 데이터 구조화 (JSON)</subtask>
        </subtasks>
      </task>
      <task id="4" ac="4">
        <desc>React Email 템플릿 생성</desc>
        <subtasks>
          <subtask>src/lib/services/email/templates/weekly-report.tsx 생성</subtask>
          <subtask>React Email 컴포넌트로 HTML 이메일 템플릿 작성</subtask>
          <subtask>주간 총 비용, 전주 대비 증감률 섹션</subtask>
          <subtask>Top 3 비용 효율 프로젝트 카드</subtask>
          <subtask>Bottom 3 개선 필요 프로젝트 카드</subtask>
          <subtask>각 프로젝트: 이름, 총 비용, 비용 대비 성과, 증감률 표시</subtask>
        </subtasks>
      </task>
      <task id="5" ac="4">
        <desc>Email Service 통합</desc>
        <subtasks>
          <subtask>Resend API 클라이언트 설정 (src/lib/services/email/resend.ts)</subtask>
          <subtask>환경 변수 RESEND_API_KEY 설정</subtask>
          <subtask>sendWeeklyReport 함수 구현 (모든 사용자 조회 및 발송)</subtask>
          <subtask>발송 실패 시 에러 로깅 (Sentry)</subtask>
          <subtask>발송 성공률 추적</subtask>
        </subtasks>
      </task>
      <task id="6" ac="5">
        <desc>Report Archive 기능 구현</desc>
        <subtasks>
          <subtask>Prisma schema에 WeeklyReport 모델 추가</subtask>
          <subtask>리포트 생성 시 데이터베이스에 저장 (generated_at, data JSON)</subtask>
          <subtask>tRPC reportRouter 생성 (getRecentReports 프로시저)</subtask>
          <subtask>src/app/(dashboard)/reports/page.tsx 생성 (리포트 아카이브 페이지)</subtask>
          <subtask>리포트 목록 표시 (최근 12주)</subtask>
          <subtask>리포트 상세 보기 기능 (모달 또는 상세 페이지)</subtask>
        </subtasks>
      </task>
      <task id="7" ac="all">
        <desc>통합 테스트 및 검증</desc>
        <subtasks>
          <subtask>Cron job 수동 트리거하여 리포트 생성 확인</subtask>
          <subtask>이메일 수신 확인 (실제 이메일 또는 테스트 계정)</subtask>
          <subtask>리포트 아카이브 페이지에서 저장된 리포트 확인</subtask>
          <subtask>Top 3 / Bottom 3 계산 로직 검증</subtask>
          <subtask>TypeScript type checking passed</subtask>
          <subtask>Production build successful</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">시스템은 매주 월요일 오전 9시 KST에 주간 리포트를 자동 생성해야 한다 (FR006)</criterion>
    <criterion id="2">리포트는 "가장 비용 효율적인 프로젝트 Top 3" 및 "개선 필요 프로젝트 Top 3"를 포함해야 한다</criterion>
    <criterion id="3">각 프로젝트에 대해 "총 비용, 비용 대비 성과, 전주 대비 증감률"을 표시해야 한다</criterion>
    <criterion id="4">리포트는 이메일로 모든 등록된 사용자에게 발송되어야 한다</criterion>
    <criterion id="5">리포트는 웹 대시보드 "리포트 아카이브" 섹션에도 저장되어야 한다</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Workflows and Sequencing - Workflow 3: 주간 리포트 생성 및 발송</section>
        <snippet>매주 월요일 오전 9시 KST Vercel Cron → GET /api/cron/weekly-report → Efficiency Calculator 실행하여 Top 3/Bottom 3 프로젝트 선정 → React Email 템플릿 렌더링 → Resend API로 이메일 발송 → Report 아카이브 저장</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>APIs and Interfaces - Cron Job Endpoints</section>
        <snippet>Cron job pattern: CRON_SECRET 검증, Idempotency 체크 (cron_logs 테이블), Report Generator 실행, Email 발송, 로그 기록</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>ADR-004: React Email for Email Templates</section>
        <snippet>React Email 라이브러리 사용 (컴포넌트 기반 이메일 템플릿), 반응형 HTML (모바일 대응), 인라인 CSS (이메일 클라이언트 호환성)</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.6: 주간 리포트 생성 및 발송</section>
        <snippet>주간 자동 비용 효율성 리포트, Top 3/Bottom 3 프로젝트, 총 비용/비용 대비 성과/전주 대비 증감률, 이메일 발송, 웹 대시보드 아카이브</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements - FR006</section>
        <snippet>시스템은 주간 리포트를 생성하여 "가장 비용 효율적인 프로젝트 Top 3" 및 "개선 필요 프로젝트 Top 3"를 하이라이트해야 한다</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/lib/services/reporting/efficiency.ts</path>
        <kind>service</kind>
        <symbol>getProjectEfficiencyRankings</symbol>
        <lines>178-252</lines>
        <reason>이미 구현된 Efficiency Calculator - Top 3/Bottom 3 프로젝트 선정에 사용. ProjectEfficiencySummary 인터페이스 및 효율성 계산 로직 포함</reason>
      </artifact>
      <artifact>
        <path>src/lib/services/reporting/efficiency.ts</path>
        <kind>service</kind>
        <symbol>calculateEfficiency</symbol>
        <lines>21-29</lines>
        <reason>비용 대비 성과 계산 함수 (efficiency = successCount / totalCost)</reason>
      </artifact>
      <artifact>
        <path>vercel.json</path>
        <kind>config</kind>
        <symbol>crons</symbol>
        <lines>2-7</lines>
        <reason>기존 daily-batch cron 설정 참조. weekly-report cron 추가 필요 (매주 월요일 오전 9시 KST = 0 0 * * 1)</reason>
      </artifact>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>CronLog</symbol>
        <lines>169-177</lines>
        <reason>Cron job Idempotency 체크용 모델. jobName, date로 unique constraint</reason>
      </artifact>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>Project, ProjectMetrics, CostData</symbol>
        <lines>75-150</lines>
        <reason>프로젝트 비용 및 성과 메트릭 데이터 모델. 리포트 생성에 필요한 데이터 출처</reason>
      </artifact>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>User, TeamMember</symbol>
        <lines>19-73</lines>
        <reason>이메일 발송 대상 사용자 조회용. User 모델의 email 필드 사용</reason>
      </artifact>
      <artifact>
        <path>src/server/api/routers/cost.ts</path>
        <kind>router</kind>
        <symbol>costRouter</symbol>
        <lines>all</lines>
        <reason>기존 tRPC router 패턴 참조. reportRouter 생성 시 동일 구조 사용 (protectedProcedure, Zod validation)</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="@react-email/components" version="^0.5.7" />
        <package name="react-email" version="^4.3.2" />
        <package name="resend" version="^6.4.0" />
        <package name="@prisma/client" version="^6.5.0" />
        <package name="@trpc/server" version="^11.0.0" />
        <package name="zod" version="^3.24.2" />
        <package name="date-fns" version="^4.1.0" />
        <package name="pino" version="^10.1.0" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Vercel Cron Jobs는 best-effort 실행 보장. Idempotency 체크 필수 (CronLog 테이블 사용)</constraint>
    <constraint>React Email 템플릿은 인라인 CSS 사용 (이메일 클라이언트 호환성)</constraint>
    <constraint>주간 리포트 cron schedule: "0 0 * * 1" (매주 월요일 00:00 UTC = KST 09:00)</constraint>
    <constraint>Resend API: 환경 변수 RESEND_API_KEY 필요, 발송 실패 시 retry logic 및 Sentry 로깅</constraint>
    <constraint>WeeklyReport 모델 추가 필요: id, week_start, week_end, data (Json), generated_at</constraint>
    <constraint>tRPC reportRouter: protectedProcedure 사용하여 인증된 사용자만 접근</constraint>
    <constraint>Efficiency Calculator (Story 1.3) 재사용: getProjectEfficiencyRankings 함수</constraint>
    <constraint>Email 발송 대상: 모든 등록된 사용자 (User 테이블 조회)</constraint>
    <constraint>리포트 아카이브: 최근 12주 리포트 표시</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/cron/weekly-report</name>
      <kind>Vercel Cron Endpoint</kind>
      <signature>
        export async function GET(request: Request): Promise&lt;Response&gt;
        - Header: Authorization Bearer {CRON_SECRET}
        - Response: { success: boolean, reportId?: string, error?: string }
      </signature>
      <path>src/app/api/cron/weekly-report/route.ts</path>
    </interface>
    <interface>
      <name>generateWeeklyReport</name>
      <kind>Service Function</kind>
      <signature>
        export async function generateWeeklyReport(teamIds: string[]): Promise&lt;WeeklyReportData&gt;
        - Returns: { weekStart: Date, weekEnd: Date, totalCost: number, projects: ProjectSummary[], top3: Project[], bottom3: Project[] }
      </signature>
      <path>src/lib/services/reporting/report-generator.ts (NEW)</path>
    </interface>
    <interface>
      <name>sendWeeklyReport</name>
      <kind>Service Function</kind>
      <signature>
        export async function sendWeeklyReport(to: string[], reportData: WeeklyReportData): Promise&lt;void&gt;
        - Uses Resend API to send React Email template
        - Includes retry logic and error handling
      </signature>
      <path>src/lib/services/email/resend.ts (NEW)</path>
    </interface>
    <interface>
      <name>getProjectEfficiencyRankings</name>
      <kind>Service Function (EXISTING)</kind>
      <signature>
        export async function getProjectEfficiencyRankings(teamIds: string[], days = 30): Promise&lt;ProjectEfficiencySummary[]&gt;
        - Returns sorted array of projects by efficiency (descending)
        - Includes projectId, projectName, totalCost, successCount, feedbackScore, efficiency, costTrend
      </signature>
      <path>src/lib/services/reporting/efficiency.ts</path>
    </interface>
    <interface>
      <name>reportRouter.getRecentReports</name>
      <kind>tRPC Procedure</kind>
      <signature>
        getRecentReports: protectedProcedure
          .input(z.object({ limit: z.number().default(12) }))
          .query(async ({ input, ctx }) =&gt; { ... })
        - Returns: WeeklyReport[] (최근 12주 리포트)
      </signature>
      <path>src/server/api/routers/report.ts (NEW)</path>
    </interface>
    <interface>
      <name>WeeklyReportEmail</name>
      <kind>React Email Component</kind>
      <signature>
        export default function WeeklyReportEmail(props: WeeklyReportData): JSX.Element
        - Props: { weekStart, weekEnd, totalCost, projects, top3, bottom3 }
        - Returns: Responsive HTML email template
      </signature>
      <path>src/lib/services/email/templates/weekly-report.tsx (NEW)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit Tests (Vitest): Service 함수 테스트 (generateWeeklyReport, sendWeeklyReport, calculateWeekChange)
      Integration Tests (Vitest + MSW): Cron endpoint 테스트 (CRON_SECRET 검증, Idempotency), Resend API mocking
      E2E Tests (Playwright): Cron job 수동 트리거 → 이메일 수신 확인, 리포트 아카이브 페이지 접근 및 리포트 목록 확인
      All tests use Vitest for unit/integration, Playwright for E2E, MSW for API mocking
    </standards>
    <locations>
      - Unit tests: src/lib/services/**/*.test.ts
      - Integration tests: src/app/api/**/*.test.ts
      - E2E tests: __tests__/e2e/**/*.spec.ts
    </locations>
    <ideas>
      <test ac="1">
        <desc>Cron job CRON_SECRET validation</desc>
        <approach>Mock request with invalid/missing CRON_SECRET → expect 401 error</approach>
      </test>
      <test ac="1">
        <desc>Cron job Idempotency check</desc>
        <approach>Run cron twice for same date → second run should skip generation, return cached result</approach>
      </test>
      <test ac="2">
        <desc>Top 3 / Bottom 3 project ranking</desc>
        <approach>Create test projects with known efficiency values → verify correct ranking</approach>
      </test>
      <test ac="3">
        <desc>Week-over-week cost change calculation</desc>
        <approach>Mock cost data for 2 weeks → verify percentage change calculation accuracy</approach>
      </test>
      <test ac="4">
        <desc>Email sending to all users</desc>
        <approach>Mock Resend API → verify correct recipient list and email content</approach>
      </test>
      <test ac="5">
        <desc>Report archive storage</desc>
        <approach>Generate report → verify WeeklyReport record created in database with correct data</approach>
      </test>
      <test ac="5">
        <desc>Report archive retrieval</desc>
        <approach>Call tRPC reportRouter.getRecentReports → verify returns last 12 weeks in desc order</approach>
      </test>
    </ideas>
  </tests>
</story-context>
