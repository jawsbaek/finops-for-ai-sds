# 통합 테스트 가이드

## 개요

이 문서는 FinOps for AI 시스템의 통합 테스트 시나리오와 절차를 설명합니다.

## 테스트 환경 준비

### 1. 테스트 데이터 생성

테스트용 사용자와 샘플 데이터를 자동으로 생성합니다:

```bash
# 테스트 데이터 생성
bun run seed:test

# 테스트 데이터 정리 (clean up)
bun run seed:clean
```

생성되는 테스트 계정:
- **이메일**: test1@example.com, test2@example.com, test3@example.com
- **비밀번호**: test1234 (모든 계정 공통)

각 테스트 계정은 자동으로 다음을 포함합니다:
- 개인 팀 (예: "AI 개발팀", "데이터 분석팀")
- 샘플 프로젝트
- 프로젝트 메트릭

### 2. 기존 사용자 마이그레이션 (프로덕션)

팀이 없는 기존 사용자들을 마이그레이션합니다:

```bash
# Dry run (미리보기)
bun run migrate:users

# 실제 마이그레이션 실행
bun run migrate:users --execute
```

---

## 통합 테스트 시나리오

### 시나리오 1: 신규 사용자 회원가입 및 팀 생성

**목적**: 신규 사용자가 회원가입 후 자동으로 팀이 생성되는지 검증

**절차**:
1. `/signup` 페이지 접속
2. 이메일, 비밀번호, 이름 입력 후 회원가입
3. 로그인 성공 후 대시보드로 리다이렉트
4. 네비게이션에서 "팀 관리" 클릭
5. **검증**: 자동 생성된 팀이 표시되어야 함 (예: "사용자명's Team")

**예상 결과**:
- ✅ 팀이 자동으로 생성됨
- ✅ 사용자가 팀의 'owner' 역할을 가짐
- ✅ 팀 목록에서 팀 정보 확인 가능

---

### 시나리오 2: 팀 생성 → API 키 추가 → 프로젝트 생성

**목적**: 팀 관리의 전체 워크플로우 검증

**절차**:

#### Step 1: 팀 생성
1. 테스트 계정으로 로그인 (test1@example.com / test1234)
2. 네비게이션에서 "팀 관리" 클릭
3. "새 팀 생성" 버튼 클릭
4. 팀명: "테스트팀", 예산: 1000 입력 후 생성
5. **검증**: 팀 상세 페이지로 자동 이동

#### Step 2: API 키 추가
1. 팀 상세 페이지에서 "API 키 추가" 버튼 클릭
2. OpenAI API 키 입력 (형식: sk-proj-... 또는 sk-...)
3. **검증**:
   - API 키가 마스킹되어 표시 (예: sk-proj-****...****1234)
   - "활성" 뱃지 표시
   - 팀당 1개의 API 키만 허용되므로 "API 키 추가" 버튼 비활성화

#### Step 3: 프로젝트 생성
1. 네비게이션에서 "프로젝트" 클릭
2. "새 프로젝트" 버튼 클릭
3. 프로젝트명, 설명 입력 후 생성
4. **검증**:
   - 프로젝트가 생성된 팀에 자동으로 귀속됨
   - 프로젝트 목록에 표시

**예상 결과**:
- ✅ 팀 생성 성공
- ✅ API 키 암호화 저장 (KMS envelope encryption)
- ✅ 프로젝트가 팀에 귀속
- ✅ Novel Pattern 2 (아키텍처 기반 귀속) 구현 확인

---

### 시나리오 3: 팀이 없는 사용자 처리

**목적**: 팀이 없는 사용자에게 적절한 안내 제공 검증

**절차**:

#### Option A: 기존 사용자 시뮬레이션
```sql
-- 테스트용: 팀 멤버십 삭제
DELETE FROM team_members WHERE user_id = '<user_id>';
```

#### Option B: 새 계정 생성 후 팀 삭제
1. 새 계정으로 회원가입
2. DB에서 해당 사용자의 team_members 레코드 삭제
3. 로그아웃 후 재로그인

#### 검증 단계
1. "프로젝트" 페이지 접속
2. **검증**:
   - "팀이 없습니다" 경고 메시지 표시
   - "팀 생성하러 가기" 버튼 표시
   - "새 프로젝트" 버튼이 "팀 생성하기"로 변경
3. "팀 생성하러 가기" 클릭
4. **검증**: 팀 관리 페이지로 이동
5. 팀 생성
6. 프로젝트 페이지로 돌아가기
7. **검증**: 정상적으로 프로젝트 생성 가능

**예상 결과**:
- ✅ 팀이 없을 때 명확한 안내 메시지
- ✅ 액션 유도 버튼으로 팀 생성 페이지 이동
- ✅ 팀 생성 후 정상 플로우 진행

---

### 시나리오 4: 비용 데이터 자동 귀속 (Novel Pattern 2)

**목적**: API 키 기반 비용 자동 귀속 검증

**절차**:
1. 팀에 OpenAI API 키 등록
2. Daily batch cron job 실행 (수동 또는 예약)
   ```bash
   curl -X GET http://localhost:3000/api/cron/daily-batch \
        -H "Authorization: Bearer $CRON_SECRET"
   ```
3. **검증**:
   - `cost_data` 테이블에서 `team_id` 자동 설정 확인
   - API 키로 수집된 비용이 해당 팀에 귀속
   - 팀별 비용 차트에 데이터 표시

**예상 결과**:
- ✅ API 키를 기반으로 팀 자동 식별
- ✅ 비용 데이터에 team_id 자동 설정
- ✅ 수동 태깅 없이 비용 귀속

---

### 시나리오 5: 팀별 비용 Top 5 차트

**목적**: 대시보드 차트 및 데이터 표시 검증

**절차**:
1. 여러 팀 생성 (최소 3개)
2. 각 팀에 샘플 비용 데이터 추가
3. 대시보드 홈 페이지 접속
4. **검증**:
   - "팀별 비용 Top 5" 차트 표시
   - 바 차트 형태로 팀별 비용 표시
   - 예산 대비 비용 비교 표시
   - 차트 클릭 시 팀 상세 페이지로 이동

**예상 결과**:
- ✅ Recharts BarChart 렌더링
- ✅ 최근 7일 팀별 비용 집계
- ✅ 클릭 네비게이션 동작

---

### 시나리오 6: API 키 비활성화

**목적**: API 키 비활성화 및 audit 로깅 검증

**절차**:
1. 팀 상세 페이지에서 API 키 확인
2. "비활성화" 버튼 클릭
3. 비활성화 사유 입력 (예: "보안 위반 의심")
4. 확인 클릭
5. **검증**:
   - API 키 상태가 "비활성"으로 변경
   - Audit log에 기록 (userId, actionType, reason)
   - 비활성화된 API 키는 비용 수집에서 제외

**예상 결과**:
- ✅ API 키 비활성화 성공
- ✅ Audit log 생성
- ✅ Daily batch에서 비활성 키 스킵

---

## 에러 상황 테스트

### E1: 중복 API 키 방지
- 팀에 이미 API 키가 있는 상태에서 추가 시도
- **예상**: "이미 API 키가 존재합니다" 에러 메시지

### E2: 잘못된 API 키 형식
- OpenAI가 아닌 형식의 키 입력 (예: "invalid-key")
- **예상**: "유효한 OpenAI API 키를 입력하세요" 에러

### E3: 권한 없는 팀 접근
- 다른 팀의 상세 페이지에 직접 URL 접근
- **예상**: 403 Forbidden 에러 또는 리다이렉트

### E4: 프로젝트 생성 시 팀 없음
- 팀이 없는 상태에서 프로젝트 생성 시도
- **예상**: "팀을 먼저 생성해주세요" 토스트 메시지 + 팀 생성 액션 버튼

---

## 테스트 체크리스트

### 팀 관리
- [ ] 팀 생성 (이름, 예산)
- [ ] 팀 목록 조회
- [ ] 팀 상세 정보 표시
- [ ] 팀 정보 수정
- [ ] 팀 멤버 표시
- [ ] 팀 삭제 (cascade)

### API 키 관리
- [ ] OpenAI API 키 등록
- [ ] API 키 암호화 저장 (KMS)
- [ ] API 키 마스킹 표시
- [ ] API 키 활성/비활성 상태 관리
- [ ] 팀당 1개 제약 조건
- [ ] API 키 비활성화 + audit log

### 프로젝트 관리
- [ ] 프로젝트 생성 (팀 귀속)
- [ ] 프로젝트 목록 조회
- [ ] 프로젝트 상세 정보
- [ ] 프로젝트 메트릭 표시

### 비용 데이터
- [ ] API 키 기반 팀 자동 식별
- [ ] 비용 데이터 수집 (daily batch)
- [ ] 팀별 비용 집계
- [ ] 팀별 비용 Top 5 차트

### UX/UI
- [ ] 팀 없음 경고 메시지
- [ ] 액션 유도 버튼 (팀 생성)
- [ ] 로딩 상태 표시
- [ ] 에러 메시지 토스트
- [ ] 네비게이션 메뉴

### 보안
- [ ] KMS envelope encryption
- [ ] 팀 접근 권한 검증
- [ ] Audit logging
- [ ] Input validation (Zod)

---

## 테스트 데이터 정리

테스트 완료 후 데이터를 정리합니다:

```bash
# 테스트 계정 및 관련 데이터 삭제
bun run seed:clean
```

또는 특정 사용자만 삭제:

```sql
-- 특정 테스트 사용자 삭제 (cascade로 팀, 프로젝트도 삭제됨)
DELETE FROM users WHERE email = 'test1@example.com';
```

---

## 문제 해결

### 팀이 자동 생성되지 않음
- `src/server/api/routers/auth.ts` 확인
- 회원가입 로직에서 `teamMemberships.create` 구문 확인

### API 키 암호화 실패
- AWS KMS 설정 확인 (.env)
- KMS_KEY_ID 환경 변수 설정 확인

### 비용 데이터 수집 안됨
- Daily batch cron job 실행 확인
- OpenAI API 키 유효성 확인
- API 키 활성 상태 확인

---

## 참고 문서

- [Story 1.7: 팀별 API 키 생성 및 자동 귀속](./stories/1-7-팀별-api-키-생성-및-자동-귀속.md)
- [사용자 마이그레이션 가이드](../scripts/MIGRATION_GUIDE.md)
- [Architecture: Novel Pattern 2](./architecture.md#novel-patterns)
