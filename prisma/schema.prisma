// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

// FinOps for AI - Core Data Models

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  sessions           Session[]
  teamMemberships    TeamMember[]
  projectMemberships ProjectMember[]

  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Team {
  id        String   @id @default(cuid())
  name      String
  ownerId   String?  @map("owner_id") // Team owner/lead
  budget    Decimal? @db.Decimal(10, 2) // Monthly budget in USD
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members             TeamMember[]
  projects            Project[]
  organizationApiKeys OrganizationApiKey[] // ✅ Changed from singular to array
  tokenUsage          TokenUsage[]

  @@index([ownerId])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  role      String   @default("member") // 'owner', 'admin', 'member'
  createdAt DateTime @default(now()) @map("created_at")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@map("team_members")
}

// Team-level OpenAI Organization Admin API Key for Costs API
model OrganizationApiKey {
  id             String  @id @default(cuid())
  teamId         String  @map("team_id") // ✅ Remove @unique to allow 1:N
  provider       String // 'openai', 'anthropic', 'aws', 'azure'
  organizationId String? @map("organization_id") // Provider's org identifier

  // KMS Envelope Encryption (same pattern as ApiKey)
  encryptedKey     String @map("encrypted_key") @db.Text
  encryptedDataKey String @map("encrypted_data_key") @db.Text
  iv               String // Initialization vector

  // Security and metadata
  last4    String  @db.VarChar(4) // Last 4 chars for UI display
  isActive Boolean @default(true) @map("is_active")
  keyType  String  @default("admin") @map("key_type") // 'admin' | 'service_account'

  // NEW: Display name for UI
  displayName String? @map("display_name")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // NEW: Compound unique constraint
  @@unique([teamId, provider, organizationId], name: "unique_team_provider_org")
  @@index([teamId])
  @@index([provider, isActive])
  @@map("organization_api_keys")
}

model Project {
  id          String  @id @default(cuid())
  teamId      String  @map("team_id")
  name        String
  description String?

  // NEW: Provider-specific organization + project identifiers
  aiProvider       String? @map("ai_provider") // 'openai', 'anthropic', etc.
  aiOrganizationId String? @map("ai_organization_id") // Links to OrganizationApiKey
  aiProjectId      String? @map("ai_project_id") // Provider's project identifier

  // Legacy field (keep for backward compatibility)
  openaiProjectId String? @unique @map("openai_project_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  team       Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  members    ProjectMember[]
  apiKeys    ApiKey[] // Deprecated: Usage API project keys (to be reviewed after migration)
  costData   CostData[]
  tokenUsage TokenUsage[]
  metrics    ProjectMetrics?
  costAlerts CostAlert[]

  // NEW: Compound unique constraint
  @@unique([aiProvider, aiOrganizationId, aiProjectId], name: "unique_provider_org_project")
  @@index([teamId])
  @@index([openaiProjectId])
  // NEW: Indexes for cost collection queries
  @@index([aiProvider, aiOrganizationId])
  @@index([teamId, aiProvider, aiOrganizationId])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId], map: "idx_project_member_user")
  @@index([projectId, userId], map: "idx_project_member_lookup")
  @@map("project_members")
}

// Novel Pattern 1: Value Metrics Collector
model ProjectMetrics {
  id            String @id @default(cuid())
  projectId     String @unique @map("project_id")
  successCount  Int    @default(0) @map("success_count")
  feedbackScore Float? @map("feedback_score") // 1-5 average

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_metrics")
}

model ApiKey {
  id               String   @id @default(cuid())
  projectId        String   @map("project_id")
  provider         String // 'openai', 'aws', 'azure', etc.
  encryptedKey     String   @map("encrypted_key") @db.Text
  encryptedDataKey String   @map("encrypted_data_key") @db.Text
  iv               String // Initialization vector for AES encryption
  last4            String   @db.VarChar(4) // Last 4 chars for display (security: never send encrypted key to client)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  project  Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  costData CostData[]

  @@index([projectId], map: "idx_api_key_project")
  @@index([provider], map: "idx_api_key_provider")
  @@index([last4], map: "idx_api_key_last4")
  @@index([projectId, isActive], map: "idx_api_key_active_filter")
  @@map("api_keys")
}

model CostData {
  id        String @id @default(cuid())
  projectId String @map("project_id")

  // Deprecated: Usage API fields (nullable after migration)
  apiKeyId   String? @map("api_key_id") // Nullable to preserve historical data
  snapshotId String? @map("snapshot_id") // OpenAI Usage API snapshot_id for deduplication
  tokens     Int?
  model      String?

  // Common fields (both APIs)
  provider String // 'openai', 'aws', 'azure'
  service  String // Usage API: 'gpt-4', Costs API: line_item
  cost     Decimal  @db.Decimal(10, 2)
  date     DateTime @db.Date // Usage API: single date, Costs API: converted from bucketStartTime

  // Costs API specific fields
  bucketStartTime DateTime? @map("bucket_start_time") // Unix timestamp → DateTime
  bucketEndTime   DateTime? @map("bucket_end_time")
  lineItem        String?   @map("line_item") // e.g., "Image models", "GPT-4"
  currency        String?   @default("usd")

  // API version tracking (to distinguish data source)
  apiVersion String @default("usage_v1") @map("api_version") // 'usage_v1' | 'costs_v1'

  // Novel Pattern 1: Context
  taskType   String? @map("task_type")
  userIntent String? @map("user_intent")

  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id])
  apiKey  ApiKey? @relation(fields: [apiKeyId], references: [id])

  // Deduplication strategy - separate for each API version
  @@unique([projectId, bucketStartTime, bucketEndTime, lineItem, apiVersion], name: "unique_cost_bucket")
  @@unique([apiKeyId, date, snapshotId], name: "unique_usage_snapshot") // Legacy Usage API
  @@index([projectId, date])
  @@index([date]) // For aggregations across projects
  @@index([apiVersion]) // Query optimization for API version filtering
  @@map("cost_data")
}

model CostAlert {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  thresholdType   String    @map("threshold_type")
  thresholdValue  Decimal   @map("threshold_value") @db.Decimal(10, 2)
  isActive        Boolean   @default(true) @map("is_active")
  lastAlertSentAt DateTime? @map("last_alert_sent_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([isActive])
  @@map("cost_alerts")
}

model CronLog {
  id         String   @id @default(cuid())
  jobName    String   @map("job_name")
  date       String // YYYY-MM-DD
  executedAt DateTime @default(now()) @map("executed_at")

  @@unique([jobName, date])
  @@map("cron_logs")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  actionType   String   @map("action_type") // 'api_key_disabled', 'api_key_enabled'
  resourceType String   @map("resource_type") // 'api_key'
  resourceId   String   @map("resource_id")
  metadata     Json? // { reason: string, previous_state: any }
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt], map: "idx_audit_log_user_time")
  @@index([resourceType, resourceId], map: "idx_audit_log_resource")
  @@index([actionType], map: "idx_audit_log_action")
  @@index([createdAt], map: "idx_audit_log_time")
  @@map("audit_logs")
}

model WeeklyReport {
  id          String   @id @default(cuid())
  weekStart   DateTime @map("week_start") @db.Date
  weekEnd     DateTime @map("week_end") @db.Date
  data        Json // { totalCost, weekChange, projects: [...], top3: [...], bottom3: [...] }
  generatedAt DateTime @default(now()) @map("generated_at")

  @@index([weekStart])
  @@map("weekly_reports")
}

// Token Usage Data from OpenAI Usage API
// Stores detailed token usage metrics for analysis and cost calculation
model TokenUsage {
  id        String @id @default(cuid())
  projectId String @map("project_id")
  teamId    String @map("team_id")

  // Provider information
  provider       String // 'openai', 'anthropic', etc.
  organizationId String? @map("organization_id") // Provider's org ID
  aiProjectId    String? @map("ai_project_id") // Provider's project ID (can be null/empty)

  // Model and request information
  model            String // e.g., 'gpt-4-0613', 'gpt-3.5-turbo'
  numModelRequests Int    @map("num_model_requests") // Number of API requests

  // Token breakdown
  inputTokens         Int @map("input_tokens") // Total input tokens
  outputTokens        Int @map("output_tokens") // Total output tokens
  inputCachedTokens   Int @default(0) @map("input_cached_tokens")
  inputUncachedTokens Int @default(0) @map("input_uncached_tokens")

  // Text tokens
  inputTextTokens       Int @default(0) @map("input_text_tokens")
  outputTextTokens      Int @default(0) @map("output_text_tokens")
  inputCachedTextTokens Int @default(0) @map("input_cached_text_tokens")

  // Audio tokens
  inputAudioTokens       Int @default(0) @map("input_audio_tokens")
  inputCachedAudioTokens Int @default(0) @map("input_cached_audio_tokens")
  outputAudioTokens      Int @default(0) @map("output_audio_tokens")

  // Image tokens
  inputImageTokens       Int @default(0) @map("input_image_tokens")
  inputCachedImageTokens Int @default(0) @map("input_cached_image_tokens")
  outputImageTokens      Int @default(0) @map("output_image_tokens")

  // Time bucket information
  bucketStartTime DateTime @map("bucket_start_time")
  bucketEndTime   DateTime @map("bucket_end_time")
  date            DateTime @db.Date // Derived from bucketStartTime for easier querying

  // API tracking
  apiVersion String @default("usage_completions_v1") @map("api_version") // 'usage_completions_v1'

  // Metadata
  userId      String? @map("user_id") // OpenAI user_id (if available)
  apiKeyId    String? @map("api_key_id") // OpenAI api_key_id (if available)
  batch       String? // Batch identifier (if applicable)
  serviceTier String? @map("service_tier") // Service tier (if applicable)

  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Deduplication: same project, time bucket, model, and provider
  @@unique([projectId, bucketStartTime, bucketEndTime, model, provider, aiProjectId], name: "unique_token_usage_bucket")
  @@index([projectId, date])
  @@index([teamId, date])
  @@index([date])
  @@index([model])
  @@index([provider])
  @@map("token_usage")
}

// Cap.js CAPTCHA Token Storage (Serverless-Compatible)
// Replaces file-based .cap-tokens storage for Vercel/AWS Lambda/etc.
model CaptchaToken {
  id        String   @id @default(cuid())
  token     String   @unique // CAPTCHA token identifier
  type      String // 'challenge' or 'solution'
  data      Json // Challenge/solution data (varies by type)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Indexes for efficient queries and cleanup
  @@index([expiresAt]) // For cleanup cron job
  @@index([token, type]) // For lookups
  @@map("captcha_tokens")
}
